# Audit Trail Implementation Plan

## Overview
This document outlines the implementation plan for the Audit Trail feature, including both backend API endpoints and frontend UI components for displaying audit logs.

## Requirements Analysis

### From Frontend_Spec.txt
**Audit Trail**:
- Audit data should be surfaced in at least two places:
  1. **Within entity detail pages** (scoped to that entity) - e.g., Employee Detail page
  2. **Standalone activity feed or log page** showing recent system-wide activity

### From Domain_Model.txt
**Audit Log**:
- An immutable record of every significant domain event
- Each entry captures:
  - Event type
  - Affected entity
  - Timestamp
  - The actor (who triggered it)
  - Before/after snapshot for mutations
- Generated by one of the background workers

### From Backend_Spec.txt
- Background Worker 1 (.NET) subscribes to domain events and creates audit logs
- Events are published for all significant state changes (creation, updates, status transitions, deletions)

## Current State Analysis

### Backend
✅ **Implemented**:
- `AuditLog` model in `WorkforceAPI` (different structure from worker)
- `AuditLogEntry` model in `WorkerService.AuditLogger` (used by worker)
- Basic `AuditLogRepository` (only `GetAllAsync`, returns `object`)
- Worker service that consumes events and creates audit logs

❌ **Missing**:
- Service layer for audit logs in `WorkforceAPI`
- Controller endpoints for audit logs
- Filtering methods (by entity type, entity ID, event type, date range)
- Proper type safety (currently uses `object`)
- DTOs for audit log responses

### Frontend
✅ **Implemented**:
- `AuditLog` type definition
- Basic API client (`auditLogsApi`) with methods for getting logs

❌ **Missing**:
- Audit Trail page (system-wide activity feed)
- Audit log component for entity detail pages
- React Query hooks for audit logs
- Filtering UI (by entity type, event type, date range)
- Display components for before/after snapshots

### Worker Service
✅ **Implemented**:
- Worker consumes RabbitMQ events
- Creates audit log entries in MongoDB
- Uses `AuditLogEntry` model (simpler structure)

⚠️ **Issue**:
- Worker uses `AuditLogEntry` model
- API uses `AuditLog` model
- Need to align or create mapping between them

## Implementation Plan

### Phase 1: Backend API Enhancements

#### 1.1 Align Audit Log Models
- [ ] Check if `AuditLogEntry` (worker) and `AuditLog` (API) need to be aligned
- [ ] Decide on single model or mapping strategy
- [ ] Ensure worker creates logs in format expected by API

#### 1.2 Refactor Repository Layer
- [ ] Update `IAuditLogRepository` to use `AuditLog` instead of `object`
- [ ] Update `AuditLogRepository` implementation
- [ ] Add filtering methods:
  - `GetByEntityTypeAsync(string entityType)`
  - `GetByEntityIdAsync(string entityType, string entityId)`
  - `GetByEventTypeAsync(string eventType)`
  - `GetByDateRangeAsync(DateTime startDate, DateTime endDate)`
  - `GetRecentAsync(int limit = 100)`
- [ ] Add sorting (most recent first)

#### 1.3 Create Service Layer
- [ ] Create `IAuditLogService` interface
- [ ] Create `AuditLogService` implementation
- [ ] Methods: `GetAllAsync`, `GetByEntityAsync`, `GetByEventTypeAsync`, `GetRecentAsync`
- [ ] Add pagination support if needed

#### 1.4 Create Controller
- [ ] Create `AuditLogsController`
- [ ] Endpoints:
  - `GET /api/auditlogs` - Get all with optional filters
  - `GET /api/auditlogs/recent` - Get recent activity (for dashboard)
  - `GET /api/auditlogs/entity/{entityType}/{entityId}` - Get logs for specific entity
  - `GET /api/auditlogs/event/{eventType}` - Get logs by event type
- [ ] Query parameters: `?entityType=`, `?eventType=`, `?startDate=`, `?endDate=`, `?limit=`
- [ ] Return appropriate HTTP status codes

#### 1.5 Create DTOs (Optional but Recommended)
- [ ] `AuditLogListDto` - For list views (simplified)
- [ ] `AuditLogDetailDto` - For detail views (with full before/after)
- [ ] Map entities to DTOs in service layer

### Phase 2: Frontend Implementation

#### 2.1 React Query Hooks
- [ ] Create `useAuditLogs` hook (with filtering support)
- [ ] Create `useAuditLogsByEntity` hook (for entity detail pages)
- [ ] Create `useRecentAuditLogs` hook (for dashboard)
- [ ] Add proper query invalidation

#### 2.2 Audit Trail Page (System-Wide)
- [ ] Create `AuditTrail.tsx` page
- [ ] Display audit logs in timeline/feed format
- [ ] Add filtering UI:
  - Entity type filter (All, Employee, Project, Task, LeaveRequest)
  - Event type filter (created, updated, deleted, etc.)
  - Date range picker
- [ ] Show: event type, entity, actor, timestamp, before/after snapshots
- [ ] Add pagination or infinite scroll
- [ ] Add loading and error states

#### 2.3 Audit Log Component (Entity-Scoped)
- [ ] Create `EntityAuditLog.tsx` component
- [ ] Display audit logs for a specific entity
- [ ] Show in Employee Detail, Project Detail pages
- [ ] Compact timeline view
- [ ] Expandable before/after snapshots

#### 2.4 Before/After Snapshot Display
- [ ] Create `AuditSnapshot.tsx` component
- [ ] Display JSON before/after data in readable format
- [ ] Highlight differences (optional enhancement)
- [ ] Collapsible/expandable sections

#### 2.5 Routing
- [ ] Add route in `App.tsx`: `/audit` or `/audit-trail`
- [ ] Update Navbar link to point to correct route

#### 2.6 Integration with Entity Detail Pages
- [ ] Add `EntityAuditLog` component to `EmployeeDetail.tsx`
- [ ] Add `EntityAuditLog` component to `ProjectDetail.tsx` (optional)
- [ ] Ensure proper entity type and ID passing

### Phase 3: Worker Model Alignment

#### 3.1 Model Consistency
- [ ] Review `AuditLogEntry` (worker) vs `AuditLog` (API) models
- [ ] Ensure worker creates logs with all required fields:
  - EventId, EventType, EntityType, EntityId, Actor, Timestamp, Before, After, Metadata
- [ ] Update worker if needed to match API model structure

## Technical Decisions

### Backend Architecture
- **Repository Layer**: Use `AuditLog` type instead of `object` for type safety
- **Service Layer**: Handle business logic and filtering
- **DTOs**: Optional but recommended for list views (reduce payload size)
- **Filtering**: Support query parameters for flexible filtering

### Frontend Architecture
- **State Management**: Use React Query for server state
- **UI Components**: Reuse existing components (Card, Button, etc.)
- **Timeline Display**: Use a vertical timeline layout for audit logs
- **Before/After**: Display as formatted JSON or key-value pairs

### Data Flow
1. Domain event occurs → Event published to RabbitMQ
2. Worker consumes event → Creates audit log in MongoDB
3. Frontend requests audit logs → API queries MongoDB → Returns logs
4. Frontend displays logs in timeline format

## File Structure

### Backend Files to Create/Modify
```
backend/WorkforceAPI/
├── Controllers/
│   └── AuditLogsController.cs (new)
├── Services/
│   ├── IAuditLogService.cs (new)
│   └── AuditLogService.cs (new)
├── Repositories/
│   ├── IAuditLogRepository.cs (enhance)
│   └── AuditLogRepository.cs (enhance)
└── Models/
    └── DTOs/
        ├── AuditLogListDto.cs (optional, new)
        └── AuditLogDetailDto.cs (optional, new)
```

### Frontend Files to Create/Modify
```
frontend/src/
├── pages/
│   └── AuditTrail.tsx (new)
├── components/
│   └── audit/
│       ├── EntityAuditLog.tsx (new)
│       ├── AuditSnapshot.tsx (new)
│       └── AuditLogCard.tsx (optional, new)
├── hooks/
│   └── useAuditLogs.ts (new)
└── api/
    └── endpoints/
        └── auditLogs.api.ts (enhance)
```

## Success Criteria

✅ **Backend**:
- All filtering endpoints work correctly
- Audit logs are queryable by entity, event type, date range
- Type safety maintained throughout
- Recent activity endpoint works for dashboard

✅ **Frontend**:
- System-wide audit trail page displays all activity
- Entity-scoped audit logs show in detail pages
- Filtering works correctly
- Before/after snapshots are readable
- All states (loading, error, empty) are handled

## Next Steps

1. Start with Phase 1: Backend API enhancements
2. Then Phase 2: Frontend implementation
3. Finally Phase 3: Worker model alignment (if needed)
